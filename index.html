<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Hex General Evolved - Modular</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- ====================================================================== -->
    <!-- ===================== MODAL DE BIENVENIDA Y AYUDA ==================== -->
    <!-- ====================================================================== -->
    <div id="welcomeHelpModal" class="modal" style="display: none;">
        <div class="modal-content help-modal-content">
            <span class="close-button" id="closeWelcomeHelpBtn" title="Cerrar">×</span>
            <h2 id="welcomeHelpTitle" style="text-align: center; color: #333; margin-bottom: 20px;"></h2>
            <div id="welcomeHelpSections">
                <!-- Las secciones de ayuda se añadirán aquí por JS -->
            </div>
            <p id="welcomeHelpFooter" style="text-align: center; margin-top: 25px; font-style: italic; color: #555;"></p>
            <div style="text-align: center; margin-top: 20px;">
                <label for="doNotShowAgainCheckbox" style="font-size: 0.9em; color: #666; cursor: pointer;">
                    <input type="checkbox" id="doNotShowAgainCheckbox" style="margin-right: 5px;">
                    No mostrar de nuevo al iniciar
                </label>
                <button id="startGameFromHelpBtn" style="margin-top: 15px; padding: 10px 20px; font-size: 1.1em;">Empezar Juego</button>
            </div>
        </div>
    </div>
        
    <!-- ====================================================================== -->
    <!-- ===================== PANTALLA DE MENÚ PRINCIPAL ===================== -->
    <!-- ====================================================================== -->
    <div id="mainMenuScreen" class="modal" style="display: none; text-align: center; align-items: center; justify-content: center;">
        <div class="modal-content" style="width: auto; min-width: 300px; max-width: 500px;">
            <h2>Hex General Evolved</h2>
            <button id="startCampaignBtn" style="display: block; width: 80%; margin: 20px auto; padding: 15px; font-size: 1.1em;">Comenzar Campaña</button>
            <button id="startSkirmishBtn" style="display: block; width: 80%; margin: 20px auto; padding: 15px; font-size: 1.1em;">Partida Rápida (Escaramuza)</button>
            <button id="joinNetworkGameBtn" style="display: block; width: 80%; margin: 20px auto; padding: 15px; font-size: 1.1em; background-color: #ffc107; color: black;">Unirse a Partida en Red</button>
            <button id="startTutorialBtn" style="display: block; width: 80%; margin: 20px auto; padding: 15px; font-size: 1.1em; background-color: #28a745;">Iniciar Tutorial</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ====== PANTALLA DE CONFIGURACIÓN DE PARTIDA RÁPIDA (ESCARAMUZA) ====== -->
    <!-- ====================================================================== -->
    <div id="setupScreen" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Configuración de Partida Rápida</h2>
            <div id="skirmish-options-container"> 
                <div>
                    <label for="player1Type">Jugador 1:</label>
                    <select id="player1Type">
                        <option value="human" selected>Humano</option>
                        <option value="ai_easy">IA (Fácil)</option>
                        <option value="ai_normal">IA (Normal)</option>
                        <option value="ai_hard">IA (Difícil)</option>
                    </select>
                </div>
                <div>
                    <label for="player1Civ">Civilización J1:</label>
                    <select id="player1Civ">
                            <option value="ninguna" selected>Ninguna</option>
                            <option value="Roma">Roma</option>
                            <option value="Grecia">Grecia</option>
                            <option value="Cartago">Cartago</option>
                            <option value="Egipto">Egipto</option>
                            <option value="Galia">Galia</option>
                            <option value="Germania">Germania</option>
                            <option value="Britania">Britania</option>
                            <option value="Iberia">Iberia</option>
                            <option value="Persia">Persia</option>
                            <option value="China">China</option>
                            <option value="Vikingos">Vikingos</option>
                            <option value="Mongol">Mongolia</option>
                            <option value="Arábiga">Arabia</option>
                            <option value="Mameluca">Sultanato Mameluco</option>
                            <option value="Otomana">Imperio Otomano</option>
                            <option value="Maya">Civilización Maya</option>
                            <option value="Asiria">Asiria</option>
                            <option value="Babilonia">Babilonia</option>
                            <option value="Japón">Japón</option>
                    </select>
                </div>
                <div id="player1AiLevelDiv" style="display:none;">
                    <label for="player1AiLevel">Nivel IA Jugador 1:</label>
                    <select id="player1AiLevel">
                        <option value="easy">Fácil</option>
                        <option value="normal" selected>Normal</option>
                        <option value="hard">Difícil</option>
                    </select>
                </div>
                <div>
                    <label for="player2Type">Jugador 2:</label>
                    <select id="player2Type">
                        <option value="human">Humano</option>
                        <option value="ai_easy">IA (Fácil)</option>
                        <option value="ai_normal" selected>IA (Normal)</option>
                        <option value="ai_hard">IA (Difícil)</option>
                    </select>
                </div>
                <div>
                    <label for="player2Civ">Civilización J2:</label>
                    <select id="player2Civ">
                            <option value="ninguna" selected>Ninguna</option>
                            <option value="Roma">Roma</option>
                            <option value="Grecia">Grecia</option>
                            <option value="Cartago">Cartago</option>
                            <option value="Egipto">Egipto</option>
                            <option value="Galia">Galia</option>
                            <option value="Germania">Germania</option>
                            <option value="Britania">Britania</option>
                            <option value="Iberia">Iberia</option>
                            <option value="Persia">Persia</option>
                            <option value="China">China</option>
                            <option value="Vikingos">Vikingos</option>
                            <option value="Mongol">Mongolia</option>
                            <option value="Arábiga">Arabia</option>
                            <option value="Mameluca">Sultanato Mameluco</option>
                            <option value="Otomana">Imperio Otomano</option>
                            <option value="Maya">Civilización Maya</option>
                            <option value="Asiria">Asiria</option>
                            <option value="Babilonia">Babilonia</option>
                            <option value="Japón">Japón</option>
                    </select>
                </div>
                <div>
                    <label for="resourceLevel">Nivel de Recursos:</label>
                    <select id="resourceLevel">
                        <option value="min" selected>Mínimos</option>
                        <option value="med">Medios</option>
                        <option value="max">Muchos</option>
                    </select>
                </div>
                <div>
                    <label for="boardSizeSelect">Tamaño del Tablero:</label>
                    <select id="boardSizeSelect">
                        <option value="small" selected>Pequeño (12x15)</option>
                        <option value="medium">Mediano (18x25)</option>
                        <option value="large">Grande (24x35)</option>
                    </select>
                </div>
                <div>
                    <label for="initialUnitsCount">Límite Despliegue:</label>
                    <select id="initialUnitsCount">
                        <option value="1">1 Unidad</option>
                        <option value="3" selected>3 Unidades</option>
                        <option value="5">5 Unidades</option>
                        <option value="unlimited">Ilimitadas</option>
                    </select>
                </div>
            </div>    
            <div class="setup-actions" style="margin-top: 25px; display: flex; justify-content: space-around; gap: 10px;">
                <button id="startLocalGameBtn" style="flex: 1; padding: 12px; font-size: 1.05em;">Empezar Partida (Local)</button>
                <button id="createNetworkGameBtn" style="flex: 1; padding: 12px; font-size: 1.05em; background-color: #007bff;">Crear Partida en Red</button>
            </div>
            <button id="backToMainMenuBtn_fromSetup" style="margin-top:15px; background-color: #6c757d; width:auto; padding: 10px 15px;">Volver al Menú</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- ========= PANTALLA DE LOBBY DEL ANFITRIÓN (ESPERANDO JUGADOR) ======== -->
    <!-- ====================================================================== -->
    <div id="hostLobbyScreen" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Lobby de Partida en Red</h2>
            <div class="container">
                <h3>Tu partida está lista</h3>
                <p>Comparte este código con el otro jugador para que pueda unirse:</p>
                <p style="font-size: 1.8em; font-weight: bold; color: #007bff; letter-spacing: 3px; margin: 15px 0; user-select: all;" id="short-game-code">Generando...</p>
                <p><i>El juego comenzará automáticamente cuando se una.</i></p>
            </div>
            <div class="container">
                <p>Estado: <span id="host-status" class="status desconectado">Esperando jugador...</span></p>
                <ul id="host-player-list">
                    <!-- Los nombres de los jugadores aparecerán aquí -->
                </ul>
            </div>
            <button id="backToMainMenuBtn_fromHostLobby" style="margin-top:20px; background-color: #6c757d;">Cancelar y Volver</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== PANTALLA DEL ARBOL DE TECNOLOGÍA ================== -->
    <!-- ====================================================================== -->
    <div id="techTreeScreen" class="modal" style="display: none; background-color: rgba(0,0,0,0.85);">
        <div class="modal-content tech-tree-content" style="width: 80%; max-width: 700px; height: 70vh; overflow: auto; background-color: #1e2a38; border: 2px solid #4a5568; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 10px;">
            <span class="close-button" id="closeTechTreeBtn" title="Cerrar">×</span>
            <h2 style="text-align: center; color: #e2e8f0; margin-top:15px; margin-bottom: 15px; font-size: 1.5em;">Árbol de Tecnologías</h2>
            <div id="techTreeContainer" style="position: relative; width: 1500px; height: 1000px; background-color: #2d3748; margin: 0 auto; border-radius: 5px;"></div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== PANTALLA DEL MAPA MUNDIAL (CAMPAÑA) =================== -->
    <!-- ====================================================================== -->
    <div id="worldMapScreen" style="display: none; position: relative; width: 90%; max-width: 960px; height: 640px; margin: 20px auto; border: 2px solid #333; background-color: #a7bbc7; overflow: hidden;">
        <img id="worldMapImage" src="" alt="Mapa del Mundo" style="width: 100%; height: 100%; object-fit: contain;">
        <div id="territoryMarkerContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
        <div id="campaignMessages" class="floating-messages bottom-left">Mensajes de campaña...</div>
        <button id="backToMainMenuBtn_fromCampaign" class="floating-btn top-right" style="font-size: 16px; width: auto; padding: 5px 10px; border-radius: 5px;">Menú</button>
    </div>

    <!-- ====================================================================== -->
    <!-- ================== MODAL DE BRIEFING DEL ESCENARIO ================== -->
    <!-- ====================================================================== -->
    <div id="scenarioBriefingModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="closeScenarioBriefingBtn" title="Cerrar">×</span>
            <h2 id="scenarioTitle" style="text-align:center; margin-bottom:15px;">Título</h2>
            <img id="scenarioImage" src="" alt="Escenario" style="max-width: 100%; max-height: 300px; margin:0 auto 20px; display:none;">
            <p id="scenarioDescription">Descripción...</p>
            <button id="startScenarioBattleBtn" style="font-size: 1.1em; padding: 12px 20px;">Comenzar Batalla</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== CONTENEDOR DEL JUEGO TÁCTICO =================== -->
    <!-- ====================================================================== -->
    <div class="game-container" style="display: none;"> 
        <div id="gameBoard"></div>
        <div id="turnBlocker" class="turn-blocker" style="display: none;">Esperando al Oponente...</div>
        <div id="floatingMenuPanel" class="floating-panel top-left-panel" style="display: none;">
            <h4 id="floatingMenuTitle">Fase: - <br> Turno 1 - Jugador -</h4>
            <div id="playerResourcesGrid_float" class="playerResourcesGrid_common">
            <div class="resource-labels">
            <span>Oro</span><span>Fe</span><span>Pi</span><span>Ma</span><span>Com</span><span>Inv</span><span>PR</span>
            </div>
                <div class="resource-values">
                    <span data-resource="oro">0</span>
                    <span data-resource="hierro">0</span>
                    <span data-resource="piedra">0</span>
                    <span data-resource="madera">0</span>
                    <span data-resource="comida">0</span>
                    <span data-resource="researchPoints">0</span>
                    <span data-resource="puntosReclutamiento">0</span>
                </div>
            </div>
            <button id="concedeBattleBtn_float" class="panel-button">Rendirse</button>
            <button id="saveGameBtn_float" class="panel-button">Guardar Partida</button>
            <label for="loadGameInput_float" class="button-like-label panel-button">Cargar Partida</label>
            <input type="file" id="loadGameInput_float" accept=".json" style="display: none;">
            <button id="backToMainFromBattleBtn" class="panel-button" style="background-color:#6c757d;">Volver al Menú Principal</button>
        </div>
    </div> 

    <!-- ====================================================================== -->
    <!-- ===================== PANEL INFERIOR               =================== -->
    <!-- ====================================================================== -->
    <div id="contextualInfoPanel">
    <div id="contextualHeader">
        <!-- BOTÓN NUEVO PARA EXPANDIR/CONTRAER -->
        <button id="expandPanelBtn" title="Expandir/Contraer Detalles">▲</button>
        <h3 id="contextualTitle">Información</h3>
    </div>
    <div id="contextualContent">
        <!-- El contenido detallado (unidad, casilla) irá aquí -->
    </div>
    <button id="closeContextualPanelBtn">×</button>
</div>


    <!-- ====================================================================== -->
    <!-- =================== MODAL DE DETALLES DE DIVISIÓN ==================== -->
    <!-- ====================================================================== -->
    <div id="unitDetailModal" class="modal" style="display: none;">
        <div class="modal-content unit-detail-content">
            <span class="close-button" id="closeUnitDetailModalBtn">×</span>
            <h3 id="unitDetailTitle">Detalles de la División</h3>
            <div class="unit-main-stats">
                <div class="stat-row">
                    <span class="stat-label">Salud:</span>
                    <div class="unit-total-health-bar-container">
                        <div id="unitDetailTotalHealthBar" class="unit-total-health-bar"></div>
                    </div>
                    <span id="unitDetailTotalHealthText">2000 / 2000</span>
                </div>
                <div class="stat-row stat-summary">
                    <span id="unitDetailCombatStats">A/D: 400/600</span>
                    <span id="unitDetailMovementStats">Mov: 2</span>
                    <span id="unitDetailVisionStats">Vis: 3</span>
                </div>
                <div class="stat-row">
                    <span id="unitDetailMorale">Moral: 50/125 (Normal)</span>
                    <span id="unitDetailXP">XP: 120/150 (Regular)</span>
                </div>
            </div>
            <h4 class="regiment-section-title">Regimientos</h4>
            <ul id="unitDetailRegimentList" class="regiments-list detailed-regiments-list"></ul>
            <div id="unitDetailFooter" style="text-align: center; margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
                <button id="disbandUnitBtn" class="button-danger">Disolver Unidad</button>
            </div>
        </div>
    </div>
    
    <!-- ====================================================================== -->
    <!-- ======================= MODAL DE LA WIKI DEL JUEGO ===================== -->
    <!-- ====================================================================== -->
    <div id="wikiModal" class="modal" style="display: none;">
        <div class="modal-content wiki-content">
            <span class="close-button" id="closeWikiModalBtn">×</span>
            <h2>Wiki del Juego</h2>
            <div class="wiki-tabs">
                <button class="wiki-tab-btn active" data-tab="regimientos">Regimientos</button>
                <button class="wiki-tab-btn" data-tab="estructuras">Estructuras e Ingresos</button>
                <button class="wiki-tab-btn" data-tab="tecnologias">Investigación</button>
                <button class="wiki-tab-btn" data-tab="conceptos">Conceptos Clave</button>
            </div>
            <div class="wiki-tab-content">
                <div id="wiki-tab-regimientos" class="wiki-page active">
                    <p>Valoraciones de 1 a 5 estrellas (⭐) para Ataque, Defensa, Salud, Movimiento y Rango.</p>
                    <div class="table-container"><table id="wikiRegimentsTable"></table></div>
                </div>
                <div id="wiki-tab-estructuras" class="wiki-page">
                    <h3>Estructuras</h3>
                    <div class="table-container"><table id="wikiStructuresTable"></table></div>
                    <h3>Ingresos por Territorio (Base)</h3>
                    <div class="table-container"><table id="wikiIncomeTable"></table></div>
                </div>
                <div id="wiki-tab-tecnologias" class="wiki-page">
                    <p>Las tecnologías desbloquean nuevas unidades y estructuras.</p>
                    <div class="table-container"><table id="wikiTechTable"></table></div>
                </div>
                <div id="wiki-tab-conceptos" class="wiki-page">
                    <h3>Conceptos Clave del Juego</h3>
                    <div id="wikiConceptsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- =================== MODALES DE JUEGO TÁCTICO ========================= -->
    <!-- ====================================================================== -->

    <div id="unitManagementModal" class="modal" style="display: none;">
        <div class="modal-content unit-management-content">
            <span class="close-button" id="closeUnitManagementModalBtn">×</span>
            <h3 id="unitManagementTitle">Crear Nueva División</h3>
            <div class="unit-management-body">
                <div class="unit-selection-panel">
                    <div id="unitCategoryTabs" class="category-tabs"></div>
                    <div id="availableUnitsList" class="available-units-list"></div>
                </div>
                <div class="division-summary-panel">
                    <h4>Resumen de la División</h4>
                    <div class="division-name-editor">
                        <label for="divisionNameInput">Nombre:</label>
                        <input type="text" id="divisionNameInput" value="Nueva División" maxlength="25">
                    </div>
                    <ul id="divisionCompositionList"></ul>
                    <div class="summary-details">
                        <p><strong>Coste Total:</strong> <span id="divisionCostSummary">0 Oro</span></p>
                        <p><strong>Stats Agregados:</strong> <span id="divisionStatsSummary">A:0 D:0 M:0</span></p>
                        <p><strong>Regimientos:</strong> <span id="divisionRegimentCount">0 / 20</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer-actions">
                <button id="cancelUnitManagementBtn" class="button-secondary">Cancelar</button>
                <button id="finalizeUnitManagementBtn">Finalizar y Colocar</button>
            </div>
        </div>
    </div>
    
    <div id="buildStructureModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h3>Construir Estructura en (<span id="buildHexCoordsDisplay"></span>)</h3>
            <ul id="availableStructuresList"></ul>
            <button id="confirmBuildBtn">Construir Seleccionado</button>
        </div>
    </div>

    <div id="advancedSplitUnitModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button" id="closeAdvancedSplitModalBtn">×</span>
            <h3>Dividir <span id="advancedSplitUnitNameDisplay"></span></h3>
            <p style="font-size: 0.9em;">Mueve regimientos para formar una nueva unidad.</p>
            <div class="split-regiment-container">
                <div class="regiment-column">
                    <h4>Unidad Original (<span id="originalUnitRegimentCount"></span>)</h4>
                    <p>Stats: <span id="originalUnitPreviewStats"></span></p>
                    <p>Salud: <span id="originalUnitPreviewHealth"></span></p>
                    <ul id="originalUnitRegimentsList" class="regiments-list"></ul>
                </div>
                <div class="regiment-column">
                    <h4>Nueva Unidad (<span id="newUnitRegimentCount"></span>)</h4>
                    <input type="text" id="newSplitUnitNameInput" value="Nueva División" maxlength="20">
                    <p>Stats: <span id="newUnitPreviewStats"></span></p>
                    <p>Salud: <span id="newUnitPreviewHealth"></span></p>
                    <ul id="newUnitRegimentsList" class="regiments-list"></ul>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="finalizeAdvancedSplitBtn">Confirmar División</button>
                <button id="cancelAdvancedSplitBtn" style="background-color: #6c757d;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="gameLogContainer" class="game-log-container"></div>

    <!-- ====================================================================== -->
    <!-- ===================== BOTONES FLOTANTES INDIVIDUALES ================= -->
    <!-- ====================================================================== -->
    <button id="floatingMenuBtn">☰</button>
    <button id="floatingTechTreeBtn">💡</button>
    <button id="floatingEndTurnBtn">►</button>
    <button id="floatingCreateDivisionBtn" style="display: none;">➕</button> 
    <button id="setAsCapitalBtn" style="display: none;">👑</button> 
    <button id="floatingConsoleBtn">C</button>
    <button id="floatingUndoMoveBtn" title="Deshacer Movimiento">↩</button>
    <button id="floatingReinforceBtn" title="Reforzar Unidad">💪</button>
    <button id="floatingSplitBtn" title="Dividir Unidad">✂</button>
    <button id="floatingBuildBtn" title="Construir Estructura">🏗️</button>
    <button id="floatingPillageBtn" title="Saquear Hexágono">💰</button>
    <button id="floatingWikiBtn" title="Wiki del Juego">i</button>
    <div id="combatPredictionPanel" style="display: none;"></div>

    <!-- ====================================================================== -->
    <!-- ===================== CARGA DE SCRIPTS ===================== -->
    <!-- ====================================================================== -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="constants.js"></script>
    <script src="state.js"></script>
    <script src="technologyTree.js"></script> 
    <script src="worldMapData.js"></script>
    <script src="maps/tactical_britain_coast_map.js"></script>
    <script src="scenarios/tutorial_scenario.js"></script>
    <script src="scenarios/britain_defense_scenario.js"></script>
    <script src="domElements.js"></script> 
    <script src="utils.js"></script>
    <script src="cheats.js"></script> 
    <script src="debugConsole.js"></script>
    <script src="uiUpdates.js"></script>
    <script src="techScreenUI.js"></script>
    <script src="boardManager.js?v=1"></script>
    <script src="unit_Actions.js"></script>
    <script src="modalLogic.js"></script>
    <script src="networkManager.js"></script> 
    <script src="aiLogic.js"></script>
    <script src="gameFlow.js"></script>
    <script src="saveLoad.js"></script>
    <script src="campaignManager.js"></script>
    <script src="main.js"></script>

    <div id="debug-console" style="display: none;">
        <div id="console-output"></div>
        <input type="text" id="console-input" placeholder="Escribe un comando...">
    </div>  

</body>
</html>